name: codecov

on:
  pull_request:
    branches: [ main ]

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Fetch
        uses: actions/checkout@master

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: 'pip'

      - name: Install dependecies
        run: pip install -r requirements/requirements.txt -r requirements/requirements_test.txt -r requirements/requirements_nlp.txt -r requirements/requirements_nlp_test.txt

      - name: Cache models and datasets
        uses: actions/cache@v2
        id: cache
        with:
          path: ~/.cache/huggingface
          key: hf-hub-v1

      - name: Download models and datasets
        if: steps.cache.outputs.cache-hit != 'true'
        run: python tests/nlp/download_data.py

      - name: Test
        run: pytest tests --cov-report term --cov-report html:htmlcov --cov-report xml --cov=quantus
        env:
          USE_XLA: true
          TF_XLA_FLAGS: "--tf_xla_auto_jit=2 --tf_xla_cpu_global_jit"

      - name: Upload
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml, coverage.xml

